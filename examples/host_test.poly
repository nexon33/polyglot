// host_test.poly — Test host imports with --target host

#[rust]
fn test_console() {
    console::log("=== Console Test ===");
    console::log("Hello from Polyglot WASM on Node.js!");
    console::error("This goes to stderr");
}

fn test_env() {
    console::log("\n=== Environment Test ===");
    match env::cwd() {
        Ok(cwd) => console::log(&format!("Working directory: {}", cwd)),
        Err(e) => console::error(&format!("cwd error: {}", e)),
    }
    if let Some(path) = env::get("PATH") {
        let preview = if path.len() > 60 { &path[..60] } else { &path };
        console::log(&format!("PATH: {}...", preview));
    }
}

fn test_fs() {
    console::log("\n=== Filesystem Test ===");
    
    // Write a file
    let content = "Hello from Polyglot!\nLine 2\nLine 3";
    console::log("Writing test_output.txt...");
    match fs::write_str("test_output.txt", content) {
        Ok(_) => console::log("  Write: OK"),
        Err(e) => { console::error(&format!("  Write failed: {}", e)); return; }
    }
    
    // Read it back
    match fs::read_to_string("test_output.txt") {
        Ok(read_content) => {
            if read_content == content {
                console::log("  Read verified: matches!");
            } else {
                console::error("  Read mismatch!");
            }
        }
        Err(e) => console::error(&format!("  Read failed: {}", e)),
    }
    
    // Test stat
    match fs::stat("test_output.txt") {
        Ok(stat) => console::log(&format!("  Stat: size={}, is_file={}", stat.size, stat.is_file)),
        Err(e) => console::error(&format!("  Stat failed: {}", e)),
    }
    
    // Cleanup
    let _ = fs::remove("test_output.txt");
    console::log("  Cleanup: OK");
}

fn test_process() {
    console::log("\n=== Process Test ===");
    match process::exec("echo Hello from child process") {
        Ok((code, stdout, stderr)) => {
            console::log(&format!("  Exit code: {}", code));
            console::log(&format!("  stdout: {}", stdout.trim()));
            if !stderr.is_empty() {
                console::log(&format!("  stderr: {}", stderr.trim()));
            }
        }
        Err(e) => console::error(&format!("  exec failed: {}", e)),
    }
}

fn test_http() {
    console::log("\n=== HTTP Test ===");
    console::log("GET https://httpbin.org/get...");
    match http::get("https://httpbin.org/get") {
        Ok(resp) => {
            console::log(&format!("  Status: {}", resp.status()));
            match resp.text() {
                Ok(body) => {
                    let preview = if body.len() > 100 { &body[..100] } else { &body };
                    console::log(&format!("  Body: {}...", preview));
                }
                Err(e) => console::error(&format!("  Body read error: {}", e)),
            }
        }
        Err(e) => console::error(&format!("  HTTP failed: {}", e)),
    }
}

fn test_async() {
    console::log("\n=== Async/Timer Test ===");
    let start = async_io::now();
    console::log(&format!("Current time: {} ms", start));
    
    console::log("Sleeping 50ms...");
    async_io::sleep(50);
    let elapsed = async_io::now() - start;
    console::log(&format!("Elapsed: {} ms (expected ~50)", elapsed));
    
    // Timer test
    console::log("Setting 30ms timer...");
    let _timer = async_io::timer(30);
    let ready = async_io::wait(100);
    console::log(&format!("Events ready: {}", ready));
}

export fn main() -> i32 {
    console::log("╔════════════════════════════════════════════╗");
    console::log("║  Polyglot Host Imports Test                ║");
    console::log("╚════════════════════════════════════════════╝");
    
    test_console();
    test_env();
    test_fs();
    test_process();
    test_http();
    test_async();
    
    console::log("\n=== All Tests Complete ===");
    0
}
